<div class="dashboard-container">
  <header class="dashboard-header">
    <h1>Dashboard</h1>
    <div class="header-actions">
      <button class="btn-export-pdf" (click)="openPdfExportModal()" title="Exportar relatório em PDF">
        <img src="../assets/download.svg" alt="Exportar" class="btn-icon">
        <span>Exportar PDF</span>
      </button>

      <button class="btn-new-transaction">
        <a routerLink="/app/transacoes">+ Nova Transação</a>
      </button>
    </div>
  </header>

  @if (errorMessage) {
  <div class="error-message">
    {{ errorMessage }}
    <button (click)="refreshData()">Tentar novamente</button>
  </div>
  }

  @if (loading) {
  <div class="loading-state">
    <p>Carregando dados do dashboard...</p>
  </div>
  }

  @if (!loading) {
  <section class="stats-section">
    <div class="stats-grid">
      <div class="stat-card balance-card">
        <div class="stat-content">
          <h3>Saldo Total</h3>
          <p class="stat-value" [class]="getBalanceStatus()">{{ formatCurrency(stats.balance) }}</p>
        </div>
        <img class="stat-icon" src="/assets/saldo.svg" alt="">
      </div>

      <div class="stat-card income-card" routerLink="/app/receitas">
        <div class="stat-content">
          <h3>Receitas</h3>
          <p class="stat-value positive">{{ formatCurrency(stats.totalIncomes) }}</p>
          <span class="stat-label">Total recebido</span>
        </div>
        <img class="stat-icon" src="/assets/receitas.svg" alt="">
      </div>

      <!-- Despesas -->
      <div class="stat-card expense-card" routerLink="/app/despesas">
        <div class="stat-content">
          <h3>Despesas</h3>
          <p class="stat-value negative">{{ formatCurrency(stats.totalExpenses) }}</p>
          <span class="stat-label">Total gasto</span>
        </div>
        <img class="stat-icon" src="/assets/despesas.svg" alt="">
      </div>

      <div class="stat-card transaction-card" routerLink="/app/transacoes">
        <div class="stat-content">
          <h3>Transações</h3>
          <p class="stat-value">{{ stats.transactionCount }}</p>
          <span class="stat-label">Total de transações</span>
        </div>
        <img class="stat-icon" src="/assets/carteira.svg" alt="">
      </div>
    </div>
  </section>
  }

  @if (!loading) {
  <section class="charts-section">

    @if (chartsError) {
    <div class="error-message">
      {{ chartsError }}
      <button (click)="loadChartsData()">Tentar novamente</button>
    </div>
    }

    @if (chartsLoading) {
    <div class="charts-loading">
      <p>Carregando gráficos...</p>
    </div>
    }

    @if (!chartsLoading && !chartsError) {
    <div class="charts-grid">

      <div class="top-charts-row">
        <div class="chart-card flow-chart">
          <div class="chart-header">
            <h2>Fluxo financeiro</h2>
            <div class="chart-legend">
              <div class="legend-item">
                <span class="legend-color despesas"></span>
                <span>Despesas</span>
              </div>
              <div class="legend-item">
                <span class="legend-color receitas"></span>
                <span>Receitas</span>
              </div>
              <div class="legend-item">
                <span class="legend-color saldo"></span>
                <span>Saldo</span>
              </div>
            </div>
          </div>

          @if (chartData.length > 0) {
          <div class="chart-container">
            <div class="chart-wrapper">
              <div class="chart-y-axis">
                @for (label of getYAxisLabels(); track label) {
                <div class="y-axis-label">{{ label }}</div>
                }
              </div>
              <div class="chart-bars">
                @for (data of chartData; track data.month) {
                <div class="chart-month">
                  <div class="bars-container">
                    <div class="bar-group">
                      <!-- Barra de Despesas -->
                      <div class="bar despesas-bar" [style.height.px]="(data.despesas / getMaxValue()) * 240"
                        [title]="'Despesas: ' + formatCurrency(data.despesas)">
                      </div>
                      <!-- Barra de Receitas -->
                      <div class="bar receitas-bar" [style.height.px]="(data.receitas / getMaxValue()) * 240"
                        [title]="'Receitas: ' + formatCurrency(data.receitas)">
                      </div>
                      <!-- Barra de Saldo -->
                      <div class="bar saldo-bar" [style.height.px]="getAbsoluteHeight(data.saldo)"
                        [class.negative]="data.saldo < 0" [title]="'Saldo: ' + formatCurrency(data.saldo)">
                      </div>
                    </div>
                  </div>
                  <div class="month-label">{{ data.month }}</div>
                </div>
                }
              </div>
            </div>
          </div>
          }

          @if (chartData.length === 0) {
          <div class="no-data">
            <p>Nenhum dado disponível para o gráfico</p>
          </div>
          }
        </div>

        <div class="recent-transactions-card" (click)="goToTransactions()">
          <div class="transactions-header">
            <h3>Transações Recentes</h3>
            <span class="view-all-indicator">→</span>
          </div>
          <p class="subtitle">Você realizou {{ stats.transactionCount }} transações este mês</p>

          @if (recentTransactions.length > 0) {
          <div class="transactions-list">
            @for (transaction of recentTransactions; track transaction.id) {
            <div class="transaction-item">
              <div class="transaction-icon">
                @if (transaction.type === 'INCOME') {
                <img src="assets/up.svg" alt="Receita" class="icon-type">
                }
                @if (transaction.type === 'EXPENSE') {
                <img src="assets/down.svg" alt="Despesa" class="icon-type">
                }
              </div>
              <div class="transaction-details">
                <div class="transaction-name">{{ transaction.description }}</div>
                <div class="transaction-category">{{ transaction.category }} - {{ formatDate(transaction.date) }}</div>
                <div class="transaction-account">{{ transaction.account }}</div>
              </div>
              <div class="transaction-amount" [class.positive]="transaction.type === 'INCOME'"
                [class.negative]="transaction.type === 'EXPENSE'">
                {{ transaction.type === 'INCOME' ? '+' : '-' }}{{ formatCurrency(transaction.amount) }}
              </div>
            </div>
            }
          </div>
          }

          @if (recentTransactions.length === 0) {
          <div class="no-data">
            <p>Nenhuma transação encontrada</p>
          </div>
          }

          @if (recentTransactions.length > 0) {
          <div class="show-more">
            <span>Clique para ver todas as transações</span>
          </div>
          }
        </div>
      </div>


      <div class="bottom-charts-row">
        <!-- Gastos por categoria (gráfico de barras) -->
        <div class="category-chart-card">
          <h3>Gastos por categoria</h3>
          <p class="subtitle">Distribuição de despesas por categoria no mês atual</p>

          @if (categoryData.length > 0) {
          <div class="category-chart">
            @for (category of categoryData; track category.name) {
            <div class="category-item">
              <div class="category-info">
                <span class="category-name">{{ category.name }}</span>
                <div class="category-values">
                  <span class="category-amount">{{ formatCurrency(category.value) }}</span>
                  <span class="category-percentage">{{ category.percentage }}%</span>
                </div>
              </div>
              <div class="category-bar">
                <div class="category-progress" [style.width.%]="category.percentage"
                  [style.background-color]="category.color">
                </div>
              </div>
            </div>
            }
          </div>
          }

          @if (categoryData.length === 0) {
          <div class="no-data">
            <p>Nenhuma categoria de gastos encontrada</p>
          </div>
          }
        </div>

        <!-- Receitas por categoria (gráfico de pizza) -->
        <div class="category-chart-card">
          <h3>Receitas por categoria</h3>
          <p class="subtitle">Distribuição de receitas por categoria no mês atual</p>

          @if (incomeCategoryData.length > 0) {
          <div class="pie-chart-container">
            <div class="pie-chart-wrapper">
              <div class="pie-chart">
                <svg viewBox="0 0 200 200">
                  @for (segment of incomeCategoryData; track segment.name; let i = $index) {
                  <circle cx="100" cy="100" r="80" fill="none" [attr.stroke]="segment.color" stroke-width="40"
                    [attr.stroke-dasharray]="getStrokeDashArray(segment.percentage)"
                    [attr.stroke-dashoffset]="getStrokeDashOffset(i)" class="pie-segment-path"
                    [attr.title]="segment.name + ': ' + formatCurrency(segment.value)">
                  </circle>
                  }
                </svg>
              </div>
              <div class="pie-center">
                <span class="pie-total">{{ formatCurrency(getIncomeTotal()) }}</span>
                <span class="pie-label">Total</span>
              </div>
            </div>

            <div class="pie-legend">
              @for (segment of incomeCategoryData; track segment.name) {
              <div class="legend-item">
                <span class="legend-color" [style.background-color]="segment.color"></span>
                <span class="legend-label">{{ segment.name }} ({{ segment.percentage }}%)</span>
                <span class="legend-amount">{{ formatCurrency(segment.value) }}</span>
              </div>
              }
            </div>
          </div>
          }

          @if (incomeCategoryData.length === 0) {
          <div class="no-data">
            <p>Nenhuma categoria de receita encontrada</p>
          </div>
          }
        </div>
      </div>
    </div>
    }
  </section>
  }
  <app-pdf-export-modal></app-pdf-export-modal>
</div>